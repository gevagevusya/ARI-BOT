<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>Выбор даты и времени</title>
  <style>
    body { font-family: system-ui, -apple-system, Arial; margin: 20px; color: #222; }
    label { display:block; margin:12px 0 6px; font-weight:500; }
    input, textarea, button {
      width:100%; font-size:16px; padding:10px; box-sizing:border-box; border-radius:10px; border:1px solid #ccc;
    }
    button {
      background:#64C27B; color:white; border:none; margin-top:14px;
      padding:12px; border-radius:10px; font-weight:600;
    }
  </style>
</head>
<body>
  <h3>Выберите дату и время консультации</h3>
  <label>Дата и время</label>
  <input id="dt" type="datetime-local">
  <label>Комментарий (необязательно)</label>
  <textarea id="note" rows="3" placeholder="Например: утром до 12 или после 18:00"></textarea>
  <button id="send">Отправить</button>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const WORK_START = 9;
    const WORK_END   = 19;
    const STEP_MIN   = 30;
    const MIN_HOURS  = 2;

    const dt = document.getElementById('dt');
    const pad = n => String(n).padStart(2,'0');

    function roundToStep(date, stepMin) {
      const d = new Date(date);
      const m = d.getMinutes();
      const rounded = Math.ceil(m / stepMin) * stepMin;
      d.setMinutes(rounded, 0, 0);
      return d;
    }

    function nextWorkSlot(from) {
      let d = roundToStep(from, STEP_MIN);
      const hour = d.getHours();
      if (hour < WORK_START) { d.setHours(WORK_START, 0, 0, 0); }
      if (hour >= WORK_END)  { d.setDate(d.getDate()+1); d.setHours(WORK_START, 0, 0, 0); }
      return d;
    }

    const min = new Date(Date.now() + MIN_HOURS*3600*1000);
    const start = nextWorkSlot(min);
    const toLocalInput = (d) =>
      `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;

    dt.min = toLocalInput(start);
    dt.value = toLocalInput(start);

    document.getElementById('send').onclick = () => {
      if (!dt.value) return alert('Выберите дату и время');
      const chosen = new Date(dt.value);
      const h = chosen.getHours();
      if (h < WORK_START || h >= WORK_END) return alert('Вне рабочих часов (09:00–19:00)');
      if (chosen < start) return alert('Выберите время не раньше чем через 2 часа');

      const payload = { datetimeISO: dt.value, note: document.getElementById('note').value || '' };
      tg.sendData(JSON.stringify(payload));
      tg.close();
    };
  </script>
</body>
</html>
